name: Build APK - Download no Celular

# Workflow para compilar o APK remotamente e disponibilizar para download no celular
#
# COMO USAR:
# 1. Acesse: https://github.com/laylamonteiro/witchy-app/actions
# 2. Clique em "Build APK - Download no Celular" na lista de workflows
# 3. Clique no botão "Run workflow" (lado direito)
# 4. Escolha a branch (geralmente 'main') e clique em "Run workflow"
# 5. Aguarde o build completar (~5-10 minutos)
# 6. Quando finalizar, acesse a aba "Releases" do repositório
# 7. Baixe o APK diretamente no celular pelo navegador!
#
# LINK DIRETO PARA RELEASES:
# https://github.com/laylamonteiro/witchy-app/releases
#
# CONFIGURAÇÃO NECESSÁRIA:
# Adicione os seguintes secrets nas configurações do repositório:
# Settings > Secrets and variables > Actions > New repository secret
#
# 1. GROQ_API_KEY - sua chave da API do Groq
# 2. PROKERALA_CLIENT_ID - Client ID da API Prokerala
# 3. PROKERALA_CLIENT_SECRET - Client Secret da API Prokerala

on:
  workflow_dispatch:
    inputs:
      release_name:
        description: 'Nome da release (ex: v1.0.0-beta)'
        required: false
        default: ''
      prerelease:
        description: 'Marcar como pre-release?'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.0"
          channel: stable
          cache: true

      - name: Create Groq credentials file
        run: |
          cat > lib/core/ai/groq_credentials.dart << 'CREDENTIALS'
          /// Credentials for the Groq API.
          ///
          class GroqCredentials {
            static const apiKey = '${{ secrets.GROQ_API_KEY }}';
          }
          CREDENTIALS

      - name: Create Prokerala credentials file
        run: |
          cat > lib/features/astrology/data/services/prokerala_credentials.dart << 'CREDENTIALS'
          /// Credentials for the Prokerala API.
          ///
          class ProkeralaCredentials {
            static const String clientId = '${{ secrets.PROKERALA_CLIENT_ID }}';
            static const String clientSecret = '${{ secrets.PROKERALA_CLIENT_SECRET }}';
          }
          CREDENTIALS

      - name: Install dependencies
        run: flutter pub get

      - name: Fix geolocator_android compatibility
        run: |
          # Find and patch geolocator_android build.gradle to use hardcoded SDK versions
          GEOLOCATOR_PATH=$(find ~/.pub-cache/hosted/pub.dev -name "geolocator_android-*" -type d | head -1)
          if [ -n "$GEOLOCATOR_PATH" ]; then
            BUILD_FILE="$GEOLOCATOR_PATH/android/build.gradle"
            if [ -f "$BUILD_FILE" ]; then
              echo "Patching $BUILD_FILE"
              sed -i 's/flutter.compileSdkVersion/34/g' "$BUILD_FILE"
              sed -i 's/flutter.minSdkVersion/21/g' "$BUILD_FILE"
              sed -i 's/flutter.targetSdkVersion/34/g' "$BUILD_FILE"
              echo "Patch applied successfully"
            fi
          fi

      - name: Build release APK
        run: flutter build apk --release

      - name: Get current date and time
        id: date
        run: echo "datetime=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Get version from pubspec
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Set release name
        id: release_name
        run: |
          if [ -n "${{ github.event.inputs.release_name }}" ]; then
            echo "name=${{ github.event.inputs.release_name }}" >> $GITHUB_OUTPUT
          else
            echo "name=build-${{ steps.date.outputs.datetime }}" >> $GITHUB_OUTPUT
          fi

      - name: Rename APK with version info
        run: |
          mkdir -p release-apk
          cp build/app/outputs/flutter-apk/app-release.apk release-apk/grimorio-de-bolso-${{ steps.release_name.outputs.name }}.apk

      - name: Upload APK artifact (backup)
        uses: actions/upload-artifact@v4
        with:
          name: grimorio-apk-${{ steps.date.outputs.datetime }}
          path: release-apk/*.apk

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_name.outputs.name }}
          name: "Grimório de Bolso - ${{ steps.release_name.outputs.name }}"
          body: |
            ## Download do APK

            Clique no arquivo `.apk` abaixo para baixar diretamente no seu celular!

            ### Informações do Build
            - **Versão do app**: ${{ steps.version.outputs.version }}
            - **Branch**: ${{ github.ref_name }}
            - **Commit**: ${{ github.sha }}
            - **Data**: ${{ steps.date.outputs.datetime }}
            - **Executado por**: @${{ github.actor }}

            ### Como instalar no Android
            1. Baixe o arquivo `.apk` abaixo
            2. Abra o arquivo no celular
            3. Se aparecer aviso de "fonte desconhecida", permita a instalação
            4. Pronto! O app está instalado

            ---
            *Build automático gerado via GitHub Actions*
          files: release-apk/*.apk
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          generate_release_notes: false

      - name: Output download URL
        run: |
          echo ""
          echo "=========================================="
          echo "APK PRONTO PARA DOWNLOAD!"
          echo "=========================================="
          echo ""
          echo "Acesse no seu celular:"
          echo "https://github.com/${{ github.repository }}/releases/tag/${{ steps.release_name.outputs.name }}"
          echo ""
          echo "Ou vá direto para todas as releases:"
          echo "https://github.com/${{ github.repository }}/releases"
          echo ""
          echo "=========================================="
